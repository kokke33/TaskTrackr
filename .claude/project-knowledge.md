# プロジェクト技術知識

## アーキテクチャ上の意思決定

### データベース設計
- **Drizzle ORM + PostgreSQL**: 型安全性を重視した設計
- **セッションストレージ**: PostgreSQL失敗時のMemoryStore自動フォールバック機能
- **接続リトライロジック**: storage操作での接続失敗を優雅に処理
- **マイグレーションシステム**: `server/migrations/`でのSQLファイルによるスキーマ管理

### 認証システム
- **Passport.js + セッションベース認証**: JWTではなくセッション管理を採用
- **初期ユーザー作成**: 初回実行時の自動管理者ユーザー設定
- **役割ベースミドルウェア**: `isAuthenticated`と`isAdmin`ガードによるAPI保護

### フロントエンド構成
- **React 18 + TypeScript**: 型安全性を重視したコンポーネント開発
- **Wouter**: React Routerの軽量代替としてルーティング実装
- **TanStack Query**: サーバー状態管理とキャッシュ戦略の最適化
- **Shadcn/ui**: 30以上のコンポーネントを含む一貫したデザインシステム

## 実装パターン

### フォーム処理パターン
```typescript
// React Hook Form + Zod バリデーション
- shared/schema.ts での共有スキーマ定義
- nullable データベースフィールドとnon-null コンポーネント値の差異に注意
- 既知の課題: TextAreaコンポーネントでの null 値受信エラー
```

### API ルート設計
```typescript
// server/routes.ts での RESTful API 構造
- 保護ルートでの isAuthenticated, isAdmin ミドルウェア使用
- server/storage.ts でのデータベース操作抽象化
- エラーハンドリングと適切なHTTPステータス返却
```

### AI サービス統合
```typescript
// server/ai-service.ts での設定可能なプロバイダー
- OpenAI/Ollama の動的切り替え対応
- server/ai-logger.ts での包括的なログシステム
- トークン使用量監視とコスト追跡機能
- コンテンツクリーニングと後処理機能
```

## ライブラリとツール

### 主要依存関係
- `@tanstack/react-query`: サーバー状態管理
- `react-hook-form`: フォーム状態管理
- `zod`: スキーマバリデーション
- `drizzle-orm`: データベースORM
- `tailwindcss`: ユーティリティファーストCSS
- `radix-ui`: アクセシブルUIプリミティブ

### 開発ツール
- `vite`: フロントエンドビルドツール
- `esbuild`: バックエンドビルドツール
- `typescript`: 型システム
- `drizzle-kit`: データベースマイグレーション

## 避けるべきパターン

### データベース操作
- 直接SQL操作の回避（Drizzle ORMを使用）
- マイグレーション手動実行の回避（`npm run db:push`使用）
- セッションストレージ設定の手動管理回避

### フロントエンド
- グローバル状態の過度な使用（TanStack Queryで最適化）
- 直接的なDOM操作（Reactパターンに従う）
- インラインスタイリング（TailwindCSSクラス使用）

### API設計
- ネストしたルート構造の過度な使用
- 認証なしでの機密データアクセス
- エラーレスポンスでの詳細情報露出

## パフォーマンス最適化

### ビルド最適化
- **ハイブリッドビルドシステム**: Vite（フロントエンド）+ ESBuild（バックエンド）
- **パスエイリアス**: `@/`（クライアントコード）、`@shared/`（共有型）
- **開発サーバー**: 単一`npm run dev`コマンドでフロントエンド・バックエンド同時起動

### データベース最適化
- **接続プール**: PostgreSQL接続の効率的管理
- **クエリ最適化**: Drizzle ORMによる型安全なクエリ構築
- **全文検索**: 高速な検索機能実装

### フロントエンド最適化
- **遅延読み込み**: コンポーネントとルートの動的インポート
- **メモ化**: React.memoとuseMemoの適切な使用
- **クエリキャッシュ**: TanStack Queryによる効率的なデータ管理

## セキュリティ考慮事項

### 認証・認可
- セッション管理による状態維持
- CSRFトークン実装の検討事項
- パスワードハッシュ化（実装詳細要確認）

### データ保護
- 環境変数による機密情報管理
- APIキーやシークレットのコード内ハードコーディング禁止
- ログ出力での機密情報露出防止

### AI統合セキュリティ
- AIプロバイダーAPIキーの安全な管理
- ユーザー入力のサニタイゼーション
- AI応答のコンテンツフィルタリング